# FinOps Cost Data Analyst Agent

Enterprise-grade multi-agent AI system for cloud financial operations using Google ADK with **multi-table dynamic discovery**.

üìñ **Quick Links**:
- [MIGRATION.md](./MIGRATION.md) - ‚≠ê Step-by-step setup guide (start here tomorrow!)
- [DEPLOYMENT_CHECKLIST.md](./DEPLOYMENT_CHECKLIST.md) - Enterprise deployment checklist
- [CLAUDE.md](./CLAUDE.md) - Developer guide
- [PRD_FinOps_Agent.md](./PRD_FinOps_Agent.md) - Product requirements
- [TECHNICAL_ARCHITECTURE.md](./TECHNICAL_ARCHITECTURE.md) - Complete technical documentation

## Architecture Overview

```
Root Agent (SequentialAgent) - "FinOpsCostAnalystOrchestrator"
    ‚Üì orchestrates via sub_agents=[]
Sub-Agents (LlmAgent instances with tools + output_key)
    ‚îú‚îÄ sql_generation     ‚Üí state['sql_query'] (tools: BigQuery Schema Discovery)
    ‚îú‚îÄ sql_validation     ‚Üí state['validation_result'] (tools: Security validation)
    ‚îú‚îÄ query_execution    ‚Üí state['query_results'] (tools: BigQuery Execution)
    ‚îî‚îÄ insight_synthesis  ‚Üí state['final_insights'] (no tools)
```

### Key Innovation: Dynamic Multi-Table Discovery ‚ö°

Unlike traditional SQL agents with hardcoded schemas, this agent **dynamically discovers datasets AND tables** at runtime using BigQuery's metadata API. This makes it:
- **Portable**: Works with any BigQuery project/dataset
- **Self-healing**: Adapts to schema changes automatically
- **Accurate**: Uses exact schema from source of truth
- **Intelligent**: Automatically routes queries to correct tables (cost/budget/usage)
- **Multi-source**: Generates JOIN queries across datasets for comparison analysis

## How It Works: Example Query

**User asks**: "What is the total cost for FY26?"

### Step-by-Step Flow (with Dynamic Multi-Table Discovery)

1. **SQL Generation Agent** (agent.py:45-58)
   - **Step 1a: Classify Query** - Determines user intent: COST query
   - **Step 1b: Discover Datasets** - Calls `list_dataset_ids(project)`:
     ```python
     ["cost_dataset", "budget_dataset", "usage_dataset"]
     ```
   - **Step 1c: Match Dataset** - Selects "cost_dataset" (matches "*cost*" pattern)
   - **Step 1d: Discover Tables** - Calls `list_table_ids(project, "cost_dataset")`:
     ```python
     ["cost_analysis"]
     ```
   - **Step 1e: Get Schema** - Calls `get_table_info(project, dataset, table)`:
     ```json
     {
       "schema": {"fields": [
         {"name": "date", "type": "DATE"},
         {"name": "cto", "type": "STRING"},
         {"name": "cloud", "type": "STRING"},
         {"name": "application", "type": "STRING"},
         {"name": "managed_service", "type": "STRING"},
         {"name": "environment", "type": "STRING"},
         {"name": "cost", "type": "FLOAT"}
       ]},
       "numRows": "156234"
     }
     ```
   - **Step 1f**: Uses discovered schema + business rules (FY26 = Feb 1, 2025 to Jan 31, 2026)
   - **Step 1g**: Generates SQL:
     ```sql
     SELECT SUM(cost) as total_cost
     FROM `gac-prod-471220.cost_dataset.cost_analysis`
     WHERE date BETWEEN '2025-02-01' AND '2026-01-31'
     ```
   - **Step 1h**: Writes to `state['sql_query']`

2. **SQL Validation Agent** (agent.py:65-77)
   - Reads `state['sql_query']`
   - Uses security validation tools (_tools/validation_tools.py):
     - `check_forbidden_keywords()` - Blocks DROP, DELETE, INSERT, etc.
     - `parse_sql_query()` - Validates SQL syntax
     - `validate_sql_security()` - Comprehensive security check
   - Writes "VALID" to `state['validation_result']`

3. **Query Execution Agent** (agent.py:85-94)
   - Reads `state['sql_query']`
   - Uses BigQuery Execution Toolset (_tools/bigquery_tools.py)
   - Connects to BigQuery with credentials from .env
   - Executes SQL and returns results
   - Writes to `state['query_results']`:
     ```
     total_cost
     27442275.64
     ```

4. **Insight Synthesis Agent** (agent.py:101-110)
   - Reads `state['query_results']` and `state['sql_query']`
   - Formats into business-friendly output with exact numbers
   - Writes to `state['final_insights']`:
     ```
     The total cost for FY26 (February 2025 - January 2026) was $27,442,275.64.

     This represents cloud spending across all providers and applications
     for the current fiscal year.
     ```
   - Returns final answer to user

## Multi-Table Discovery Mechanism

**Q: How does the agent know about schemas, datasets, and tables?**

**A: DYNAMIC MULTI-TABLE DISCOVERY using BigQuery ADK Toolset** ‚úÖ

### Dynamic Discovery Workflow (5 Steps)

When you ask **"What is total cost for FY26?"**, the agent:

#### Step 1: Classify Query
```
User Intent: COST query
Pattern Matching: "cost" keyword detected
Target Data: Cost dataset
```

#### Step 2: Discover All Datasets
```python
list_dataset_ids(project_id="gac-prod-471220")
# Returns: ["cost_dataset", "budget_dataset", "usage_dataset"]
```

#### Step 3: Match Dataset to Query Type
```python
# Pattern matching logic:
# COST queries ‚Üí *cost*, *spending*, *expense*
# BUDGET queries ‚Üí *budget*, *forecast*, *allocation*
# USAGE queries ‚Üí *usage*, *utilization*, *resource*

Selected: "cost_dataset"  # Matches "*cost*" pattern
```

#### Step 4: Discover Tables in Dataset
```python
list_table_ids(
    project_id="gac-prod-471220",
    dataset_id="cost_dataset"
)
# Returns: ["cost_analysis", "historical_costs"]

Selected: "cost_analysis"  # Best match for cost queries
```

#### Step 5: Get Table Schema
```python
get_table_info(
    project_id="gac-prod-471220",
    dataset_id="cost_dataset",
    table_id="cost_analysis"
)
```

**Response**:
```json
{
  "schema": {
    "fields": [
      {"name": "date", "type": "DATE"},
      {"name": "cto", "type": "STRING"},
      {"name": "cloud", "type": "STRING"},
      {"name": "application", "type": "STRING"},
      {"name": "managed_service", "type": "STRING"},
      {"name": "environment", "type": "STRING"},
      {"name": "cost", "type": "FLOAT"}
    ]
  },
  "numRows": "156234"
}
```

#### Step 6: Generate SQL
```sql
SELECT SUM(cost) as total_cost
FROM `gac-prod-471220.cost_dataset.cost_analysis`
WHERE date BETWEEN '2025-02-01' AND '2026-01-31'
```

### Multi-Table JOIN Example

**Query**: "Compare FY26 budget vs actual costs"

**Discovery Process**:
1. **Classify**: COMPARISON query (needs 2 tables)
2. **Discover**: Both cost_dataset AND budget_dataset
3. **Get Schemas**: Fetch schemas for both tables
4. **Generate JOIN**:
```sql
SELECT
  c.application,
  SUM(c.cost) as actual_cost,
  SUM(b.budget_amount) as budget,
  SUM(c.cost) - SUM(b.budget_amount) as variance
FROM `gac-prod-471220.cost_dataset.cost_analysis` c
LEFT JOIN `gac-prod-471220.budget_dataset.budget` b
  ON c.application = b.application
  AND c.date = b.date
WHERE c.date BETWEEN '2025-02-01' AND '2026-01-31'
GROUP BY c.application
ORDER BY variance DESC
LIMIT 10
```

### BigQuery Toolsets (3 Specialized Toolsets)

**1. Schema Discovery Toolset** (SQL Generation Agent)
- `list_dataset_ids`: ‚≠ê Lists all datasets in project (NEW - multi-table support)
- `list_table_ids`: ‚≠ê Lists all tables in a dataset
- `get_table_info`: ‚≠ê Fetches table schema dynamically from BigQuery
- `get_dataset_info`: Fetches dataset metadata

**2. Execution Toolset** (Query Execution Agent)
- `execute_sql`: Executes validated SQL queries (read-only)

**3. Analytics Toolset** (Future expansion - Phase 3)
- `execute_sql`: SQL execution
- `forecast`: BigQuery AI time series forecasting
- `ask_data_insights`: Natural language data insights

### Why Dynamic Multi-Table Discovery?

**Pros** (CURRENT IMPLEMENTATION):
- ‚úÖ **Portable** - Works with ANY BigQuery project/datasets (just change .env)
- ‚úÖ **Self-healing** - Automatically adapts to schema changes
- ‚úÖ **Accurate** - Uses exact schema from source of truth
- ‚úÖ **Intelligent Routing** - Automatically selects correct tables (cost/budget/usage)
- ‚úÖ **Multi-source Analysis** - Generates JOIN queries across datasets
- ‚úÖ **Explorable** - Can discover new tables/datasets without code changes
- ‚úÖ **Future-ready** - Foundation for AI forecasting & insights

**Cons**:
- Adds ~200-300ms for discovery API calls
- Requires additional IAM permissions (`bigquery.datasets.get`, `bigquery.tables.list`)

### Configuration

**Multi-Table Setup** (.env):
```bash
# REQUIRED: Your GCP Project ID
BIGQUERY_PROJECT=gac-prod-471220

# OPTIONAL: Fallback hints (if discovery fails)
BIGQUERY_DATASET=agent_bq_dataset   # Fallback cost dataset
BIGQUERY_TABLE=cost_analysis        # Fallback cost table
```

**Recommended Dataset/Table Names** (for automatic discovery):
- **Cost**: `cost_dataset.cost_analysis`
- **Budget**: `budget_dataset.budget`
- **Usage**: `usage_dataset.resource_usage`

The agent uses pattern matching to automatically discover these datasets/tables - **no hardcoding needed**!

## Prerequisites

1. **Python 3.10+**
2. **Google Cloud Project** with BigQuery enabled
3. **Google ADK**: `pip install google-adk`
4. **Authentication**: `gcloud auth application-default login`
5. **IAM Permissions** (minimum for multi-table discovery):
   - `roles/bigquery.dataViewer` (read datasets, tables, data)
   - `roles/bigquery.jobUser` (create and run queries)
   - Specific permissions needed:
     - `bigquery.datasets.get` (list and describe datasets)
     - `bigquery.tables.get` (get table schema)
     - `bigquery.tables.list` (list tables in dataset)
     - `bigquery.jobs.create` (execute queries)

## Environment Setup

Create `.env` file in project root:

```bash
# =============================================================================
# BigQuery Configuration - Multi-Table Support
# =============================================================================
# REQUIRED: Your GCP Project ID (agent discovers datasets/tables automatically)
BIGQUERY_PROJECT=gac-prod-471220

# OPTIONAL: Fallback hints (used if dynamic discovery fails)
BIGQUERY_DATASET=agent_bq_dataset    # Fallback cost dataset name
BIGQUERY_TABLE=cost_analysis         # Fallback cost table name

# =============================================================================
# Multi-Table FinOps Setup (Recommended Naming)
# =============================================================================
# The agent automatically discovers these based on pattern matching:
#
# 1. COST ANALYSIS (Actual Spending):
#    Dataset: cost_dataset, agent_bq_dataset, costs, spending
#    Table: cost_analysis, cost_data, costs
#
# 2. BUDGET (Allocations & Forecasts):
#    Dataset: budget_dataset, budgets, financial_planning
#    Table: budget, budget_allocations, forecasts
#
# 3. USAGE (Resource Utilization):
#    Dataset: usage_dataset, resource_usage, utilization
#    Table: usage, resource_usage, consumption
#
# =============================================================================

# Model Configuration (Optional)
ROOT_AGENT_MODEL=gemini-2.0-flash-exp      # Model for all agents
```

## BigQuery Table Schemas (3 Datasets)

### 1. Cost Analysis Table (Actual Spending)

```sql
CREATE TABLE `gac-prod-471220.cost_dataset.cost_analysis` (
  date DATE NOT NULL,
  cto STRING,
  cloud STRING,
  application STRING,
  managed_service STRING,
  environment STRING,
  cost FLOAT64
)
PARTITION BY DATE(date)
CLUSTER BY application, cloud;
```

### 2. Budget Table (Allocations & Forecasts)

```sql
CREATE TABLE `gac-prod-471220.budget_dataset.budget` (
  date DATE NOT NULL,
  application STRING,
  budget_amount FLOAT64,
  fiscal_year STRING,
  department STRING
)
PARTITION BY DATE(date)
CLUSTER BY application, fiscal_year;
```

### 3. Resource Usage Table (Utilization Metrics)

```sql
CREATE TABLE `gac-prod-471220.usage_dataset.resource_usage` (
  date DATE NOT NULL,
  resource_type STRING,
  application STRING,
  usage_hours FLOAT64,
  usage_amount FLOAT64
)
PARTITION BY DATE(date)
CLUSTER BY application, resource_type;
```

**Note**: Partitioning by `date` and clustering by application/cloud improves query performance by 10-100x.

## Installation

```bash
# 1. Install dependencies
pip install google-adk python-dotenv

# 2. Authenticate with Google Cloud
gcloud auth application-default login

# 3. Verify installation
python3 test_simple.py
```

## Run the Agent

### Option 1: Web Interface (Recommended)

```bash
# From parent directory (google-adk-agents/)
cd /path/to/google-adk-agents
adk web
```

Then:
1. Visit http://localhost:8000
2. Select `finops-cost-data-analyst` from dropdown
3. Start chatting!

### Option 2: CLI

```bash
cd finops-cost-data-analyst
adk run --agent agent:root_agent
```

### Option 3: Programmatic

```python
import os
os.chdir('/path/to/finops-cost-data-analyst')

from agent import root_agent

# Run query
response = root_agent.run("What is total cost for FY26?")
print(response.state['final_insights'])
```

## Example Queries

### Cost Queries (Single Table)
```
"What is the total cost for FY26?"
"What are the top 3 most expensive applications?"
"Show me GenAI costs by cloud provider"
"Which managed services cost the most in production?"
"Compare FY25 vs FY26 spending"
```

### Budget Queries (Single Table)
```
"What is our budget for FY26?"
"Show me budget allocation by department"
"What was the budget for ML Training in Q2?"
```

### Usage Queries (Single Table)
```
"How many compute hours did we use this month?"
"Show me resource utilization by application"
"What is our total storage usage?"
```

### Comparison Queries (Multi-Table JOINs)
```
"Compare FY26 budget vs actual costs"
"Are we over budget for FY26?"
"Show me applications that exceeded their budget"
"Compare actual costs vs budget vs usage for my application"
"What is the cost per compute hour?"
```

## Project Structure (Current)

```
finops-cost-data-analyst/              ‚Üê Run 'adk web' from PARENT directory
‚îú‚îÄ‚îÄ agent.py                           ‚Üê Root SequentialAgent + all sub-agents (ADK entry point)
‚îú‚îÄ‚îÄ prompts.py                         ‚Üê All prompts with DYNAMIC schema workflow
‚îú‚îÄ‚îÄ _tools/                            ‚Üê Tools package (underscore hides from ADK)
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py                    ‚Üê Exports all toolsets
‚îÇ   ‚îú‚îÄ‚îÄ validation_tools.py            ‚Üê SQL security validation functions
‚îÇ   ‚îî‚îÄ‚îÄ bigquery_tools.py              ‚Üê 3 BigQuery toolsets:
‚îÇ                                          ‚Ä¢ bigquery_schema_toolset (schema discovery)
‚îÇ                                          ‚Ä¢ bigquery_execution_toolset (query execution)
‚îÇ                                          ‚Ä¢ bigquery_analytics_toolset (AI features)
‚îú‚îÄ‚îÄ eval/
‚îÇ   ‚îî‚îÄ‚îÄ eval_data/
‚îÇ       ‚îî‚îÄ‚îÄ simple.test.json           ‚Üê Eval test cases
‚îú‚îÄ‚îÄ test_simple.py                     ‚Üê Architecture validation test
‚îú‚îÄ‚îÄ .env                               ‚Üê Environment configuration (gitignored)
‚îú‚îÄ‚îÄ .env.example                       ‚Üê Example environment file
‚îú‚îÄ‚îÄ Readme.md                          ‚Üê This file (user documentation)
‚îî‚îÄ‚îÄ CLAUDE.md                          ‚Üê Developer guide
```

**IMPORTANT**: ADK expects this flat structure. Don't nest `agent.py` in subdirectories.

## Data Flow Details

### State Dictionary (Shared Memory)

```python
state = {
    'sql_query': str,           # From sql_generation (agent.py:47)
    'validation_result': str,    # From sql_validation (agent.py:62)
    'query_results': dict,       # From query_execution (agent.py:82)
    'final_insights': str        # From insight_synthesis (agent.py:98)
}
```

### Sequential Execution Pattern

Each agent:
1. Reads from `state[...]` (previous agent's output)
2. Performs its specialized task
3. Writes to `state[output_key]` for next agent

**No tools on root agent** - only sub-agents have tools.

## Testing

### Structural Test
```bash
python3 test_simple.py
```

Validates:
- Root agent is SequentialAgent
- All sub-agents are LlmAgent
- Each sub-agent has `output_key`
- Tools are correctly attached

### Evaluation Framework
```bash
adk eval --eval-file eval/eval_data/simple.test.json
```

Tests end-to-end queries against expected results.

### Manual Testing
```bash
# Test import
python3 -c "from agent import root_agent; print(root_agent.name)"

# Test with .env
python3 -c "
from dotenv import load_dotenv
load_dotenv()
from agent import root_agent
print(f'Loaded: {root_agent.name} with {len(root_agent.sub_agents)} sub-agents')
"
```

## Key Design Principles

‚úÖ **SequentialAgent for orchestration** - Root uses `sub_agents=[]`, NOT `tools=[]`
‚úÖ **LlmAgent for tasks** - Each sub-agent has `output_key` parameter
‚úÖ **Relative imports** - Use `from .prompts import ...` (not `from prompts import ...`)
‚úÖ **State-based flow** - Data flows via `state['key']` between agents
‚úÖ **Tool isolation** - Only sub-agents have tools, never root
‚úÖ **Security first** - SQL validation before execution
‚úÖ **Dynamic multi-table discovery** - Automatically discovers datasets/tables at runtime
‚úÖ **Intelligent routing** - Pattern matching to select correct table (cost/budget/usage)
‚úÖ **Multi-source JOINs** - Generates comparison queries across datasets
‚úÖ **Specialized toolsets** - 3 BigQuery toolsets for different purposes (schema, execution, analytics)

## Common Issues & Fixes

### ‚ùå "Root Agent not found" in adk web
**Fix**: Run `adk web` from **parent directory**, not from inside `finops-cost-data-analyst/`

```bash
# WRONG
cd finops-cost-data-analyst && adk web

# CORRECT
cd google-adk-agents && adk web
```

### ‚ùå "No module named 'prompts'"
**Fix**: Use **relative imports** in `agent.py`:

```python
# WRONG
from prompts import ROOT_AGENT_DESCRIPTION

# CORRECT
from .prompts import ROOT_AGENT_DESCRIPTION
```

### ‚ùå BigQuery permission denied
**Fix**: Re-authenticate and check IAM:

```bash
gcloud auth application-default login
gcloud projects get-iam-policy YOUR_PROJECT_ID --flatten="bindings[].members" --filter="bindings.members:user:YOUR_EMAIL"
```

### ‚ùå "output_key not found in state"
**Fix**: Ensure all sub-agents have `output_key` parameter defined.

## Performance Tuning

### Temperature Settings (agent.py)
- SQL Generation: `0.01` (deterministic SQL)
- SQL Validation: `0.0` (strict security)
- Query Execution: `0.0` (deterministic)
- Insight Synthesis: `0.1` (slight creativity for formatting)

### Model Selection
- **Production**: `gemini-2.0-flash-exp` (fast, cost-effective)
- **Complex Queries**: `gemini-pro` (more capable)
- **Development**: `gemini-2.0-flash-exp` (fastest iteration)

Set via `.env`:
```bash
ROOT_AGENT_MODEL=gemini-2.0-flash-exp
```

## References

- **ADK Documentation**: https://google.github.io/adk-docs/
- **Sequential Agent Pattern**: github.com/google/adk-examples
- **BigQuery Setup**: https://cloud.google.com/bigquery/docs
- **ADK Python SDK**: github.com/google/adk-python

## Architecture Diagram (with Dynamic Schema Discovery)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  User Query: "What is total cost for FY26?"                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
                            ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Root Agent (SequentialAgent)                                    ‚îÇ
‚îÇ  - Name: FinOpsCostAnalystOrchestrator                           ‚îÇ
‚îÇ  - Role: Orchestrates 4 sub-agents sequentially                  ‚îÇ
‚îÇ  - Tools: None (orchestration only)                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚ñº                  ‚ñº                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ SQL Generation   ‚îÇ ‚îÇ SQL Validation   ‚îÇ ‚îÇ Query Execution  ‚îÇ
‚îÇ (LlmAgent)       ‚îÇ ‚îÇ (LlmAgent)       ‚îÇ ‚îÇ (LlmAgent)       ‚îÇ
‚îÇ                  ‚îÇ ‚îÇ                  ‚îÇ ‚îÇ                  ‚îÇ
‚îÇ Input:           ‚îÇ ‚îÇ Input:           ‚îÇ ‚îÇ Input:           ‚îÇ
‚îÇ - User query     ‚îÇ ‚îÇ - state['sql_    ‚îÇ ‚îÇ - state['sql_    ‚îÇ
‚îÇ                  ‚îÇ ‚îÇ   query']        ‚îÇ ‚îÇ   query']        ‚îÇ
‚îÇ ‚ö° DYNAMIC STEP: ‚îÇ ‚îÇ                  ‚îÇ ‚îÇ                  ‚îÇ
‚îÇ 1. Calls:        ‚îÇ ‚îÇ Tools:           ‚îÇ ‚îÇ Tools:           ‚îÇ
‚îÇ   get_table_info ‚îÇ ‚îÇ - check_         ‚îÇ ‚îÇ - execute_sql    ‚îÇ
‚îÇ   (BigQuery API) ‚îÇ ‚îÇ   forbidden_     ‚îÇ ‚îÇ   (BigQuery      ‚îÇ
‚îÇ                  ‚îÇ ‚îÇ   keywords       ‚îÇ ‚îÇ   Execution      ‚îÇ
‚îÇ 2. Receives:     ‚îÇ ‚îÇ - parse_sql_     ‚îÇ ‚îÇ   Toolset)       ‚îÇ
‚îÇ   schema.fields  ‚îÇ ‚îÇ   query          ‚îÇ ‚îÇ                  ‚îÇ
‚îÇ   [date, cost,   ‚îÇ ‚îÇ - validate_sql_  ‚îÇ ‚îÇ Output:          ‚îÇ
‚îÇ    cto, cloud,   ‚îÇ ‚îÇ   security       ‚îÇ ‚îÇ state['query_    ‚îÇ
‚îÇ    application,  ‚îÇ ‚îÇ   (Validation    ‚îÇ ‚îÇ results']        ‚îÇ
‚îÇ    ...] + types  ‚îÇ ‚îÇ   Toolset)       ‚îÇ ‚îÇ                  ‚îÇ
‚îÇ                  ‚îÇ ‚îÇ                  ‚îÇ ‚îÇ Example:         ‚îÇ
‚îÇ 3. Generates SQL ‚îÇ ‚îÇ Output:          ‚îÇ ‚îÇ total_cost       ‚îÇ
‚îÇ    using         ‚îÇ ‚îÇ state['          ‚îÇ ‚îÇ 27442275.64      ‚îÇ
‚îÇ    discovered    ‚îÇ ‚îÇ validation_      ‚îÇ ‚îÇ                  ‚îÇ
‚îÇ    schema        ‚îÇ ‚îÇ result']         ‚îÇ ‚îÇ                  ‚îÇ
‚îÇ                  ‚îÇ ‚îÇ                  ‚îÇ ‚îÇ                  ‚îÇ
‚îÇ Tools:           ‚îÇ ‚îÇ Example:         ‚îÇ ‚îÇ                  ‚îÇ
‚îÇ - get_table_info ‚îÇ ‚îÇ "VALID"          ‚îÇ ‚îÇ                  ‚îÇ
‚îÇ - get_dataset_   ‚îÇ ‚îÇ                  ‚îÇ ‚îÇ                  ‚îÇ
‚îÇ   info           ‚îÇ ‚îÇ                  ‚îÇ ‚îÇ                  ‚îÇ
‚îÇ - list_table_ids ‚îÇ ‚îÇ                  ‚îÇ ‚îÇ                  ‚îÇ
‚îÇ   (Schema        ‚îÇ ‚îÇ                  ‚îÇ ‚îÇ                  ‚îÇ
‚îÇ   Toolset)       ‚îÇ ‚îÇ                  ‚îÇ ‚îÇ                  ‚îÇ
‚îÇ                  ‚îÇ ‚îÇ                  ‚îÇ ‚îÇ                  ‚îÇ
‚îÇ Output:          ‚îÇ ‚îÇ                  ‚îÇ ‚îÇ                  ‚îÇ
‚îÇ state['sql_      ‚îÇ ‚îÇ                  ‚îÇ ‚îÇ                  ‚îÇ
‚îÇ query']          ‚îÇ ‚îÇ                  ‚îÇ ‚îÇ                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
                            ‚ñº
                  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                  ‚îÇ Insight          ‚îÇ
                  ‚îÇ Synthesis        ‚îÇ
                  ‚îÇ (LlmAgent)       ‚îÇ
                  ‚îÇ                  ‚îÇ
                  ‚îÇ Input:           ‚îÇ
                  ‚îÇ - state['query_  ‚îÇ
                  ‚îÇ   results']      ‚îÇ
                  ‚îÇ - state['sql_    ‚îÇ
                  ‚îÇ   query']        ‚îÇ
                  ‚îÇ                  ‚îÇ
                  ‚îÇ Tools: None      ‚îÇ
                  ‚îÇ                  ‚îÇ
                  ‚îÇ Output:          ‚îÇ
                  ‚îÇ state['final_    ‚îÇ
                  ‚îÇ insights']       ‚îÇ
                  ‚îÇ                  ‚îÇ
                  ‚îÇ Example:         ‚îÇ
                  ‚îÇ "The total cost  ‚îÇ
                  ‚îÇ for FY26 was     ‚îÇ
                  ‚îÇ $27,442,275.64.  ‚îÇ
                  ‚îÇ                  ‚îÇ
                  ‚îÇ This represents  ‚îÇ
                  ‚îÇ cloud spending   ‚îÇ
                  ‚îÇ across all       ‚îÇ
                  ‚îÇ providers..."    ‚îÇ
                  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
                           ‚ñº
                  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                  ‚îÇ  User Response     ‚îÇ
                  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Legend:
‚ö° = Dynamic schema discovery at runtime
üìä = BigQuery API call for metadata
üîí = Security validation before execution
```

---

**Built with Google ADK** | Sequential Multi-Agent Workflow | Dynamic Multi-Table Discovery ‚ö° | Intelligent Query Routing
